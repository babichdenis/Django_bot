<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Магазин{% endblock %}</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="{{ MEDIA_URL }}main/css/style.css" rel="stylesheet">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Шапка -->
    {% include 'includes/header.html' %}

    <!-- Основной контент -->
    <main class="container my-5">
        {% block content %}
        {% endblock %}
    </main>

    <!-- Modal -->
    <div class="modal fade" id="cart" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cartModalLabel">Корзина</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="show-cart table">
                        <!-- Содержимое корзины будет здесь -->
                    </table>
                    <div>Общая стоимость: <span class="total-cart">0</span> руб.</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                    <button type="button" class="btn btn-primary">Оформить заказ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Футер -->
    {% include 'includes/footer.html' %}

    <!-- Скрипты -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    {% block extra_js %}{% endblock %}
    <script src="{{ MEDIA_URL }}js/cart.js"></script>

    <!-- Добавление в корзину -->
    <script>
        // Получаем объект WebApp
        const webApp = Telegram.WebApp;

        // Получаем telegram_id
        const telegramId = webApp.initDataUnsafe.user?.id;

        if (telegramId) {
            console.log("Telegram ID:", telegramId);

            // Добавляем telegram_id в кнопку "Добавить в корзину"
            const addToCartButton = document.getElementById('add-to-cart');
            if (addToCartButton) {
                addToCartButton.dataset.telegramId = telegramId;
            }
        } else {
            console.error("Не удалось получить telegram_id");
        }

        // Обработчик кнопки "Добавить в корзину"
        const addToCartButton = document.getElementById('add-to-cart');
        if (addToCartButton) {
            addToCartButton.addEventListener('click', () => {
                const quantity = parseInt(quantityInput.value);
                const productId = addToCartButton.dataset.productId;
                const telegramId = addToCartButton.dataset.telegramId;

                fetch('/add-to-cart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        telegram_id: telegramId,
                        product_id: productId,
                        quantity: quantity,
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Товар добавлен в корзину!');
                    } else {
                        alert('Ошибка при добавлении товара в корзину.');
                    }
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                });
            });
        }
    </script>
    <!-- Корзина -->
    <script>
        // ************************************************
        // Shopping Cart API
        // ************************************************

        var shoppingCart = (function() {
            // =============================
            // Private methods and propeties
            // =============================
            cart = [];
            
            // Constructor
            function Item(name, price, count) {
                this.name = name;
                this.price = price;
                this.count = count;
            }
            
            // Save cart
            function saveCart() {
                sessionStorage.setItem('shoppingCart', JSON.stringify(cart));
            }
            
            // Load cart
            function loadCart() {
                cart = JSON.parse(sessionStorage.getItem('shoppingCart'));
            }
            if (sessionStorage.getItem("shoppingCart") != null) {
                loadCart();
            }
            

            // =============================
            // Public methods and propeties
            // =============================
            var obj = {};
            
            // Add to cart
            obj.addItemToCart = function(name, price, count) {
                for(var item in cart) {
                    if(cart[item].name === name) {
                        cart[item].count += count;
                        saveCart();
                        displayCart(); // Обновляем корзину
                        return;
                    }
                }
                var item = new Item(name, price, count);
                cart.push(item);
                saveCart();
                displayCart(); // Обновляем корзину
            }
            // Set count from item
            obj.setCountForItem = function(name, count) {
                for(var i in cart) {
                    if (cart[i].name === name) {
                        cart[i].count = count;
                        break;
                    }
                }
                saveCart();
                displayCart(); // Обновляем корзину
            };
            // Remove item from cart
            obj.removeItemFromCart = function(name) {
                for(var item in cart) {
                    if(cart[item].name === name) {
                        cart[item].count --;
                        if(cart[item].count === 0) {
                            cart.splice(item, 1);
                        }
                        break;
                    }
                }
                saveCart();
                displayCart(); // Обновляем корзину
            }

            // Remove all items from cart
            obj.removeItemFromCartAll = function(name) {
                for(var item in cart) {
                    if(cart[item].name === name) {
                        cart.splice(item, 1);
                        break;
                    }
                }
                saveCart();
                displayCart(); // Обновляем корзину
            }

            // Clear cart
            obj.clearCart = function() {
                cart = [];
                saveCart();
                displayCart(); // Обновляем корзину
            }

            // Count cart 
            obj.totalCount = function() {
                var totalCount = 0;
                for(var item in cart) {
                    totalCount += cart[item].count;
                }
                return totalCount;
            }

            // Total cart
            obj.totalCart = function() {
                var totalCart = 0;
                for(var item in cart) {
                    totalCart += cart[item].price * cart[item].count;
                }
                return Number(totalCart.toFixed(2));
            }

            // List cart
            obj.listCart = function() {
                var cartCopy = [];
                for(i in cart) {
                    item = cart[i];
                    itemCopy = {};
                    for(p in item) {
                        itemCopy[p] = item[p];

                    }
                    itemCopy.total = Number(item.price * item.count).toFixed(2);
                    cartCopy.push(itemCopy)
                }
                return cartCopy;
            }

            // cart : Array
            // Item : Object/Class
            // addItemToCart : Function
            // removeItemFromCart : Function
            // removeItemFromCartAll : Function
            // clearCart : Function
            // countCart : Function
            // totalCart : Function
            // listCart : Function
            // saveCart : Function
            // loadCart : Function
            return obj;
        })();

        // *****************************************
        // Triggers / Events
        // ***************************************** 
        // Add item
        $('.add-to-cart').click(function(event) {
            event.preventDefault();
            var name = $(this).data('name');
            var price = Number($(this).data('price'));
            shoppingCart.addItemToCart(name, price, 1);
        });

        // Clear items
        $('.clear-cart').click(function() {
            shoppingCart.clearCart();
        });

        function displayCart() {
            var cartArray = shoppingCart.listCart();
            var output = "";
            for(var i in cartArray) {
                output += "<tr>"
                    + "<td>" + cartArray[i].name + "</td>" 
                    + "<td>(" + cartArray[i].price + ")</td>"
                    + "<td><div class='input-group'><button class='minus-item input-group-addon btn btn-primary' data-name=" + cartArray[i].name + ">-</button>"
                    + "<input type='number' class='item-count form-control' data-name='" + cartArray[i].name + "' value='" + cartArray[i].count + "'>"
                    + "<button class='plus-item btn btn-primary input-group-addon' data-name=" + cartArray[i].name + ">+</button></div></td>"
                    + "<td><button class='delete-item btn btn-danger' data-name=" + cartArray[i].name + ">X</button></td>"
                    + " = " 
                    + "<td>" + cartArray[i].total + "</td>" 
                    +  "</tr>";
            }
            $('.show-cart').html(output);
            $('.total-cart').html(shoppingCart.totalCart());
            $('.total-count').html(shoppingCart.totalCount()); // Обновляем количество в шапке
        }

        // Delete item button

        $('.show-cart').on("click", ".delete-item", function(event) {
            var name = $(this).data('name')
            shoppingCart.removeItemFromCartAll(name);
        });

        // -1
        $('.show-cart').on("click", ".minus-item", function(event) {
            var name = $(this).data('name')
            shoppingCart.removeItemFromCart(name);
        });

        // +1
        $('.show-cart').on("click", ".plus-item", function(event) {
            var name = $(this).data('name')
            shoppingCart.addItemToCart(name);
        });

        // Item count input
        $('.show-cart').on("change", ".item-count", function(event) {
            var name = $(this).data('name');
            var count = Number($(this).val());
            shoppingCart.setCountForItem(name, count);
        });

        displayCart();

    </script>
</body>
</html>
