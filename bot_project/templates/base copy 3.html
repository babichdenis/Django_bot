<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Магазин{% endblock %}</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="{{ MEDIA_URL }}main/css/style.css" rel="stylesheet">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Шапка -->
    {% include 'includes/header.html' %}

    <!-- Основной контент -->
    <main class="container my-5">
        {% block content %}
        {% endblock %}
    </main>

    <!-- Modal -->
    <div class="modal fade" id="cart" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Корзина</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <table class="show-cart table">
                <thead>
                  <tr>
                    <th>Товар</th>
                    <th>Цена</th>
                    <th>Количество</th>
                    <th>Итого</th>
                    <th>Действия</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Строки с товарами будут добавляться сюда -->
                </tbody>
              </table>
              <div>Общая стоимость: $<span class="total-cart"></span></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
              <button type="button" class="btn btn-primary">Оформить заказ</button>
            </div>
          </div>
        </div>
      </div>

    <!-- Футер -->
    {% include 'includes/footer.html' %}


    <script>
        // Инициализация Telegram WebApp
        const webApp = Telegram.WebApp;
        let telegramId;

        // Загрузка корзины при старте
        document.addEventListener('DOMContentLoaded', () => {
            telegramId = webApp.initDataUnsafe.user?.id;
            if (telegramId) {
                loadCart();
            } else {
                console.error("Telegram ID не найден!");
            }
        });

        // Функция загрузки корзины
        async function loadCart() {
            try {
                const response = await fetch(`/get-cart?telegram_id=${telegramId}`);
                const data = await response.json();
                
                if (data.success) {
                    updateCartUI(data.cart_items, data.total_price);
                }
            } catch (error) {
                console.error("Ошибка загрузки корзины:", error);
            }
        }

        // Обновление интерфейса корзины
        function updateCartUI(items, total) {
            const tbody = document.querySelector('.show-cart');
            tbody.innerHTML = items.map(item => `
                <tr>
                    <td>${item.name}</td>
                    <td>${item.price} руб.</td>
                    <td>
                        <div class="input-group" style="max-width: 150px;">
                            <button class="btn btn-sm btn-outline-secondary minus" data-id="${item.id}">-</button>
                            <input type="number" class="form-control text-center" value="${item.quantity}" min="1">
                            <button class="btn btn-sm btn-outline-secondary plus" data-id="${item.id}">+</button>
                        </div>
                    </td>
                    <td>${item.total} руб.</td>
                    <td>
                        <button class="btn btn-sm btn-danger delete" data-id="${item.id}">×</button>
                    </td>
                </tr>
            `).join('');

            document.querySelector('.total-count').textContent = items.reduce((sum, item) => sum + item.quantity, 0);
            document.querySelector('.total-cart').textContent = total.toFixed(2);

            // Вешаем обработчики
            addEventListeners();
        }

        // Обработчики событий
        function addEventListeners() {
            // Удаление товара
            document.querySelectorAll('.delete').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const productId = btn.dataset.id;
                    await fetch('/remove-from-cart', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({telegram_id: telegramId, product_id: productId})
                    });
                    loadCart();
                });
            });

            // Изменение количества
            document.querySelectorAll('.minus, .plus').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const productId = btn.dataset.id;
                    const input = btn.parentNode.querySelector('input');
                    let quantity = parseInt(input.value);
                    
                    if (btn.classList.contains('minus')) {
                        quantity = Math.max(1, quantity - 1);
                    } else {
                        quantity += 1;
                    }

                    await fetch('/update-cart-item', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            telegram_id: telegramId,
                            product_id: productId,
                            quantity: quantity
                        })
                    });
                    loadCart();
                });
            });

            // Очистка корзины
            document.querySelector('.clear-cart').addEventListener('click', async () => {
                await fetch('/clear-cart', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({telegram_id: telegramId})
                });
                loadCart();
            });
        }
        function displayCart() {
            var totalCount = shoppingCart.totalCount();
            $('.total-count').html(totalCount);
            if (totalCount > 0) {
                $('.fixed-footer').show();
            } else {
                $('.fixed-footer').hide();
            }
        }
    </script>
</body>
</html>
